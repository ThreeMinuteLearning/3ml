#!/bin/bash

set +x

list_descendants ()
{
    local children=$(ps -o pid= --ppid "$1")

    for pid in $children
    do
        list_descendants "$pid"
    done

    echo "$children"
}

while true; do
  make
  make_result=$?
  server_pid=0

  if [ $make_result -eq 0 ]; then
    make serve &
    server_pid=$!
  fi

  inotifywait -re close_write . --exclude "(.git|\.#.*|.*swp?x?|.ghc.*|dist-newstyle|elm-stuff|flycheck_.*|intero|stack_work)" -e close_write,modify,delete,create,move

  if [ $server_pid -gt 0 ]; then
    kill $(list_descendants $server_pid)
  fi
done
